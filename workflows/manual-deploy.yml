name: ðŸš€ Manual Deploy Pipeline

on:
  workflow_dispatch:
    inputs:
      deployment_type:
        description: 'Type of deployment'
        required: true
        default: 'timestamp-only'
        type: choice
        options:
        - timestamp-only
        - version-increment
        - hotfix
      skip_tests:
        description: 'Skip tests (for hotfixes only)'
        required: false
        default: false
        type: boolean
      custom_message:
        description: 'Custom commit message'
        required: false
        type: string

jobs:
  manual-deploy:
    name: ðŸš€ Manual Deployment
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ•’ Generate Timestamp
        id: timestamp
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M')
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "ðŸ•’ Deployment timestamp: $TIMESTAMP"

      - name: ðŸ”¢ Handle Version Update
        id: version
        run: |
          CURRENT_VERSION=$(grep -o 'v[0-9]\+\.[0-9]\+\.[0-9]\+' index.html | head -1 | sed 's/v//')
          
          case "${{ github.event.inputs.deployment_type }}" in
            "version-increment")
              IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
              NEW_PATCH=$((PATCH + 1))
              NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
              echo "ðŸ”¢ Version incremented: $CURRENT_VERSION â†’ $NEW_VERSION"
              ;;
            "hotfix")
              IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
              NEW_PATCH=$((PATCH + 1))
              NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
              echo "ðŸ”¥ Hotfix version: $CURRENT_VERSION â†’ $NEW_VERSION"
              ;;
            *)
              NEW_VERSION="$CURRENT_VERSION"
              echo "ðŸ•’ Timestamp-only deployment, version unchanged: $NEW_VERSION"
              ;;
          esac
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: ðŸ“ Update Files
        run: |
          TIMESTAMP="${{ steps.timestamp.outputs.timestamp }}"
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          
          # Update timestamps in both versions with Build: prefix
          sed -i "s/Build: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\}/Build: $TIMESTAMP/g" index.html
          sed -i "s/Build: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\}/Build: $TIMESTAMP/g" github-pages-pythagore/index.html
          
          # Update versions if needed
          if [ "${{ github.event.inputs.deployment_type }}" != "timestamp-only" ]; then
            CURRENT_VERSION=$(grep -o 'v[0-9]\+\.[0-9]\+\.[0-9]\+' index.html | head -1 | sed 's/v//')
            sed -i "s/v$CURRENT_VERSION/v$NEW_VERSION/g" index.html
            sed -i "s/v$CURRENT_VERSION/v$NEW_VERSION/g" github-pages-pythagore/index.html
          fi

      - name: ðŸ”„ Synchronize and Verify Files
        run: |
          echo "ðŸ”„ Synchronizing files from root to GitHub Pages directory..."
          
          # Sync CSS files
          if [ -f "styles.css" ]; then
            cp "styles.css" "github-pages-pythagore/css/styles.css"
            echo "âœ… Synchronized styles.css"
          fi
          
          # Sync JavaScript files
          if [ -d "js" ]; then
            for js_file in js/*.js; do
              if [ -f "$js_file" ]; then
                cp "$js_file" "github-pages-pythagore/$js_file"
                echo "âœ… Synchronized $js_file"
              fi
            done
          fi
          
          # Verify timestamp synchronization between files
          ROOT_TIMESTAMP=$(grep -o 'Build: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\}' index.html | head -1)
          PAGES_TIMESTAMP=$(grep -o 'Build: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\}' github-pages-pythagore/index.html | head -1)
          
          if [ "$ROOT_TIMESTAMP" = "$PAGES_TIMESTAMP" ]; then
            echo "âœ… Timestamp synchronization verified: $ROOT_TIMESTAMP"
          else
            echo "âš ï¸ Timestamp mismatch detected!"
            echo "   Root: $ROOT_TIMESTAMP"
            echo "   Pages: $PAGES_TIMESTAMP"
            # Force synchronization
            sed -i "s/Build: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\}/$ROOT_TIMESTAMP/g" github-pages-pythagore/index.html
            echo "âœ… Forced timestamp synchronization"
          fi
          
          echo "ðŸ”„ File synchronization completed"

      - name: ðŸ§ª Run Quick Tests (if not skipped)
        if: ${{ !github.event.inputs.skip_tests }}
        run: |
          echo "ðŸ§ª Running quick validation tests..."
          
          # Basic HTML validation
          if command -v tidy >/dev/null 2>&1; then
            tidy -q -e index.html || echo "âš ï¸ HTML validation warnings (non-critical)"
          fi
          
          # Check for required elements
          if grep -q "form-actions" index.html && grep -q "iPhone Safari" index.html; then
            echo "âœ… Required elements found"
          else
            echo "âŒ Missing required elements"
            exit 1
          fi

      - name: ðŸ“ Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "ðŸ“ No changes to commit"
          else
            # Determine commit message
            if [ -n "${{ github.event.inputs.custom_message }}" ]; then
              COMMIT_MSG="${{ github.event.inputs.custom_message }}"
            else
              case "${{ github.event.inputs.deployment_type }}" in
                "version-increment")
                  COMMIT_MSG="Deploy: v${{ steps.version.outputs.new_version }} - ${{ steps.timestamp.outputs.timestamp }}"
                  ;;
                "hotfix")
                  COMMIT_MSG="Hotfix: v${{ steps.version.outputs.new_version }} - ${{ steps.timestamp.outputs.timestamp }}"
                  ;;
                *)
                  COMMIT_MSG="Update: Timestamp ${{ steps.timestamp.outputs.timestamp }}"
                  ;;
              esac
            fi
            
            git commit -m "$COMMIT_MSG"
            git push
            echo "âœ… Changes committed and pushed"
          fi

      - name: ðŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./github-pages-pythagore
          publish_branch: gh-pages
          commit_message: "Manual Deploy: v${{ steps.version.outputs.new_version }} - ${{ steps.timestamp.outputs.timestamp }}"

      - name: ðŸ“Š Generate Deployment Summary
        run: |
          cat > MANUAL_DEPLOY_SUMMARY.md << EOF
          # ðŸš€ Manual Deployment Summary
          
          **Deployment Type:** ${{ github.event.inputs.deployment_type }}  
          **Timestamp:** ${{ steps.timestamp.outputs.timestamp }}  
          **Version:** v${{ steps.version.outputs.new_version }}  
          **Tests Skipped:** ${{ github.event.inputs.skip_tests }}  
          **Custom Message:** ${{ github.event.inputs.custom_message || 'None' }}
          
          ## âœ… Deployment Completed Successfully
          
          - âœ… Files updated with current timestamp
          - âœ… Version management applied
          - âœ… Changes committed to repository
          - âœ… GitHub Pages deployment triggered
          
          ## ðŸŒ Live Site
          
          **URL:** https://$(echo $GITHUB_REPOSITORY | cut -d'/' -f1).github.io/$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)/
          
          **Note:** Changes may take 5-10 minutes to appear on the live site.
          
          ## ðŸ“± iPhone Safari Testing
          
          After deployment:
          1. Clear Safari cache on iPhone
          2. Visit the live URL
          3. Verify button visibility at bottom of screen
          4. Test form functionality
          
          ---
          **Deployed by:** GitHub Actions Manual Deploy  
          **Deploy Time:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          EOF
          
          echo "ðŸ“Š Manual deployment summary generated"
          cat MANUAL_DEPLOY_SUMMARY.md

      - name: ðŸ“Š Upload Deployment Summary
        uses: actions/upload-artifact@v4
        with:
          name: manual-deploy-summary
          path: MANUAL_DEPLOY_SUMMARY.md